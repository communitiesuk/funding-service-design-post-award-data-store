{% extends "find/base.html" %}

{%- from "govuk_frontend_jinja/components/accordion/macro.html" import govukAccordion -%}
{%- from 'govuk_frontend_jinja/components/checkboxes/macro.html' import govukCheckboxes -%}
{%- from 'govuk_frontend_jinja/components/select/macro.html' import govukSelect -%}
{%- from 'govuk_frontend_jinja/components/button/macro.html' import govukButton -%}
{%- from 'govuk_frontend_jinja/components/label/macro.html' import govukLabel -%}
{%- from 'govuk_frontend_jinja/components/error-summary/macro.html' import govukErrorSummary -%}
{%- from "find/main/outcomeCheckboxes.html" import outcomeCheckboxItems -%}
{%- from "find/main/checkboxes.html" import checkboxItems -%}
{%- from "find/main/select.html" import selectItems -%}

{% block content %}
<div class="govuk-grid-row">
	<div class="govuk-grid-column-full">
    {% if form.errors %}
        {{ govukErrorSummary ({
          "titleText": "There is a problem",
          "errorList": [
            {
              "text": "Select a file format",
              "href": "#"+form.file_format.id
            },

          ]
        })
        }}

    {% endif %}

    <div class="govuk-grid-row">
      <div class="govuk-grid-column-two-thirds">
        <h1 class="govuk-heading-xl">Get monitoring and evaluation data</h1>
      </div>
    </div>

    <div class="govuk-grid-row">
      <div class="govuk-grid-column-one-third">
        <form id="filter_form" method="get">
          {{ new_form.submission_id }}

          {% set html_fund %}
          {{ new_form.fund(params={"classes": "govuk-checkboxes--small"}) }}
          {% endset %}

          {% set html_region %}
          {{ new_form.region(params={"classes": "govuk-checkboxes--small"}) }}
          {% endset %}

          {% set html_organisation %}
          {{ new_form.organisation(params={"classes": "govuk-checkboxes--small"}) }}
          {% endset %}

          {% set html_outcome %}
          {{ new_form.outcome(params={"classes": "govuk-checkboxes--small"}) }}
          {% endset %}

          {{
            govukAccordion(
              {
                "id": "accordion-filters",
                "items": [
                  {"heading": {"text": "Filter by funds"}, "content": {"html": html_fund} },
                  {"heading": {"text": "Filter by regions"}, "content": {"html": html_region} },
                  {"heading": {"text": "Filter by organisations"}, "content": {"html": html_organisation} },
                  {"heading": {"text": "Filter by outcomes"}, "content": {"html": html_outcome} },
                ]
              }
            )
          }}

{#          {{ new_form.file_format(params={"classes": "govuk-radios--small"}) }}#}

{#          {{ new_form.filter_button }}#}
        </form>
      </div>

      <div class="govuk-grid-column-two-thirds">
        <h2 class="govuk-heading-m">
          {{ submissions|length }} matching submission{{ "s" if submissions|length != 0 else "" }}
        </h2>
        {% for submission in submissions %}
          <p class="govuk-body govuk-!-margin-top-4">
            <strong>Submission</strong>: {{ submission.submission_id }}
            <br>
            <strong>Submission date</strong>: {{ submission.submission_date.strftime("%A %e %B %Y") }}
            <br>
            <strong>Organisation</strong>: {{ submission.programme_junction.programme_ref.organisation.organisation_name }}
            <br>
            <strong>Fund</strong>:
              {% if submission.programme_junction.programme_ref.fund.fund_code == 'PF' %}
              Pathfinders
              {% elif submission.programme_junction.programme_ref.fund.fund_code == 'TD' %}
              Town Deal
              {% else %}
              Future High Streets
              {% endif %}
            <br>

          </p>
          {% if not loop.last %}
            <hr class="govuk-section-break govuk-section-break--visible">
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <div class="govuk-grid-row">
      <div class="govuk-grid-column-two-thirds">
        <p class="govuk-body">
          <a class="govuk-link govuk-link--no-visited-state" href="{{ url_for('find.data_glossary') }}">Access the funding glossary</a>
        </p>
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block bodyEnd %}
  {{ super() }}

  <script nonce="{{ csp_nonce() }}">
    document.getElementById('filter_form').querySelectorAll('input').forEach(function (elem) {
      elem.addEventListener('change', function() {
          document.getElementById('filter_form').submit();
      });
    })
  </script>
{% endblock bodyEnd %}
